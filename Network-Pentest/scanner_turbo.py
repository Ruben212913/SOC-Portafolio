import requests
import socket
from scapy.all import *
from generar_reporte import crear_pdf
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor # El motor de velocidad

# CONFIGURACI√ìN
VT_API_KEY = "15fb68355c222b4c34ff360792db6c4c361ae7d6e2d47fabe83acf46920c173f"
THREAT_MAP = {
    21: "FTP", 22: "SSH", 23: "Telnet", 53: "DNS", 80: "HTTP", 
    110: "POP3", 443: "HTTPS", 445: "SMB", 3306: "MySQL", 3389: "RDP"
}

# --- FUNCIONES DE APOYO ---
def obtener_geolocalizacion(ip):
    try:
        res = requests.get(f"http://ip-api.com/json/{ip}").json()
        return f"üìç UBICACI√ìN: {res.get('city')}, {res.get('country')} | ISP: {res.get('isp')}"
    except: return "Error Geo-IP"

def consultar_virustotal(ip):
    headers = {"x-apikey": VT_API_KEY}
    try:
        res = requests.get(f"https://www.virustotal.com/api/v3/ip_addresses/{ip}", headers=headers)
        if res.status_code == 200:
            s = res.json()['data']['attributes']['last_analysis_stats']
            return f"‚ò£Ô∏è REPUTACI√ìN: Maliciosos: {s['malicious']} | Sospechosos: {s['suspicious']}"
        return "‚ò£Ô∏è REPUTACI√ìN: Sin datos"
    except: return "Error VT"

# --- EL ESC√ÅNER INDIVIDUAL (Lo que har√° cada hilo) ---
puertos_abiertos = []

def escanear_puerto(ip, puerto):
    # Usamos un timeout corto para emular la velocidad de Nmap
    paquete = IP(dst=ip)/TCP(dport=puerto, flags="S")
    respuesta = sr1(paquete, timeout=0.4, verbose=False)
    
    if respuesta and respuesta.haslayer(TCP) and respuesta.getlayer(TCP).flags == 0x12:
        print(f"[!] Puerto {puerto} detectado ABIERTO")
        puertos_abiertos.append(puerto)

# --- FLUJO PRINCIPAL ---
print("\n" + "="*70)
print("üõ°Ô∏è  SOC TURBO SCANNER v6.0 (MULTI-THREADED)")
print("="*70)
objetivo = input("üåê IP a investigar: ")

geo = obtener_geolocalizacion(objetivo)
rep = consultar_virustotal(objetivo)
print(f"[*] {geo}\n[*] {rep}")

print(f"\n[*] Escaneando 1024 puertos simult√°neamente...")
inicio = datetime.now()

# Lanzamos 100 hilos al mismo tiempo
with ThreadPoolExecutor(max_workers=100) as executor:
    for p in range(1, 1025):
        executor.submit(escanear_puerto, objetivo, p)

fin = datetime.now()
print(f"\n[*] Escaneo completado en: {fin - inicio} segundos")

# Generamos el reporte final solo con los abiertos
resumen = f"REPORTE SOC TURBO - {objetivo}\n{geo}\n{rep}\n" + ("="*60) + "\n"
for p in sorted(puertos_abiertos):
    resumen += f"PUERTO {p}: ABIERTO (Analizar vulnerabilidades)\n"

crear_pdf(f"Turbo_Reporte_{objetivo.replace('.','_')}.pdf", resumen)
print(f"‚úÖ Reporte guardado.")