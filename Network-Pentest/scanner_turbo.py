import requests
import socket
import os
from scapy.all import *
from generar_reporte import crear_pdf
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor
from playwright.sync_api import sync_playwright

VT_API_KEY = "15fb68355c222b4c34ff360792db6c4c361ae7d6e2d47fabe83acf46920c173f"
os.makedirs("resultados/capturas", exist_ok=True)
os.makedirs("resultados/pdfs", exist_ok=True)
# --- FUNCIONES DE APOYO ---

def obtener_geolocalizacion(ip):
    try:
        res = requests.get(f"http://ip-api.com/json/{ip}").json()
        return f"UBICACION: {res.get('city')}, {res.get('country')} | ISP: {res.get('isp')}"
    except: return "UBICACION: No disponible"

def consultar_virustotal(ip):
    headers = {"x-apikey": VT_API_KEY}
    try:
        res = requests.get(f"https://www.virustotal.com/api/v3/ip_addresses/{ip}", headers=headers)
        s = res.json()['data']['attributes']['last_analysis_stats']
        return f"REPUTACION: Maliciosos: {s['malicious']} | Sospechosos: {s['suspicious']}"
    except: return "REPUTACION: Sin datos"

def detectar_version(ip, puerto):
    try:
        s = socket.socket()
        s.settimeout(1)
        s.connect((ip, puerto))
        if puerto == 80: s.send(b"HEAD / HTTP/1.1\r\nHost: " + ip.encode() + b"\r\n\r\n")
        banner = s.recv(1024).decode(errors='ignore').strip()
        s.close()
        return banner[:50] if banner else "Servicio activo"
    except: return "No disponible"

def capturar_pantalla(ip, puerto):
    try:
        # Si la librer√≠a est√° rota, esto saltar√° directamente al except
        from playwright.sync_api import sync_playwright
        with sync_playwright() as p:
            # ... tu c√≥digo actual ...
            return path
    except Exception as e:
        print(f"    ‚ö†Ô∏è  Aviso: Captura visual omitida (Falta configuraci√≥n de navegador)")
        return None

def analizar_riesgo_mitre(puerto):
    base_riesgos = {
        21: "RIESGO: Acceso no cifrado (FTP). Robo de credenciales (T1552).",
        22: "RIESGO: Fuerza bruta en SSH (T1110). Punto de entrada com√∫n.",
        80: "RIESGO: Trafico HTTP claro. Vulnerable a ataques Web (T1190).",
        443: "RIESGO: HTTPS. Puede ocultar canales de Comando y Control (T1573).",
        445: "RIESGO CRITICO: SMB. Propagacion de Ransomware/EternalBlue (T1210).",
        3389: "RIESGO ALTO: RDP. Acceso remoto para intrusos (T1133).",
        3306: "RIESGO: Base de datos MySQL expuesta. Fuga de datos (T1537)."
    }
    return base_riesgos.get(puerto, "RIESGO: Servicio activo. Evaluar segun version.")

# --- LOGICA DE ESCANEO ---

puertos_encontrados = []

def escanear_puerto(ip, puerto):
    paquete = IP(dst=ip)/TCP(dport=puerto, flags="S")
    res = sr1(paquete, timeout=0.4, verbose=False)
    if res and res.haslayer(TCP) and res.getlayer(TCP).flags == 0x12:
        version = detectar_version(ip, puerto)
        print(f"[!] Puerto {puerto} ABIERTO")
        puertos_encontrados.append((puerto, version))

# --- EJECUCI√ìN PRINCIPAL ---

print("üöÄ INICIANDO SOC TURBO SCANNER v2.0 (MITRE READY)")
obj = input("IP: ")
geo, rep = obtener_geolocalizacion(obj), consultar_virustotal(obj)

print(f"[*] Escaneando 1024 puertos...")
with ThreadPoolExecutor(max_workers=100) as executor:
    for p in range(1, 1025): 
        executor.submit(escanear_puerto, obj, p)

# Construcci√≥n del Reporte PDF
resumen = f"REPORTE DE AUDITORIA SOC - {obj}\n"
resumen += f"{geo}\n{rep}\n"
resumen += "="*60 + "\n"

for p, v in sorted(puertos_encontrados):
    # AQU√ç ES DONDE LLAMAMOS A LA FUNCI√ìN DE RIESGOS
    riesgo_texto = analizar_riesgo_mitre(p)
    
    resumen += f"\n[+] HALLAZGO: PUERTO {p}\n"
    resumen += f"    VERSION: {v}\n"
    resumen += f"    {riesgo_texto}\n" # Se agrega la explicaci√≥n del riesgo
    
    if p in [80, 443]:
        print(f"üì∏ Procesando evidencia visual para puerto {p}...")
        foto = capturar_pantalla(obj, p)
        if foto: 
            resumen += f"    EVIDENCIA: {foto}\n"
    
    resumen += "-"*40 + "\n"

# Guardar PDF
cnombre_archivo = f"resultados/pdfs/Turbo_{obj.replace('.','_')}.pdf"
crear_pdf(nombre_archivo, resumen.encode('latin-1', 'ignore').decode('latin-1'))

print(f"\n‚úÖ Proceso terminado. Reporte generado en: {nombre_archivo}")