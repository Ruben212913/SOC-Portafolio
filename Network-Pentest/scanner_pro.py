from scapy.all import *
from generar_reporte import crear_pdf
from datetime import datetime

objetivo = "8.8.8.8"

# 1. Definimos el diccionario de servicios (Capa de Aplicaci√≥n)
servicios = {
    21: "FTP (Transferencia de archivos)",
    22: "SSH (Acceso remoto seguro)",
    53: "DNS (Resoluci√≥n de nombres)",
    80: "HTTP (Web sin cifrar)",
    443: "HTTPS (Web segura)"
}

puertos_a_escanear = list(servicios.keys())

resumen_reporte = f"AUDITOR√çA DE RED PROFESIONAL\n"
resumen_reporte += f"Objetivo: {objetivo}\n"
resumen_reporte += f"Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
resumen_reporte += "-" * 50 + "\n"

print(f"[*] Iniciando auditor√≠a profesional en {objetivo}...")

for puerto in puertos_a_escanear:
    paquete = IP(dst=objetivo)/TCP(dport=puerto, flags="S")
    respuesta = sr1(paquete, timeout=1, verbose=False)
    
    # 2. Obtenemos el nombre del servicio, si no existe usamos "Desconocido"
    nombre_servicio = servicios.get(puerto, "Servicio Desconocido")
    
    if respuesta:
        if respuesta.haslayer(TCP) and respuesta.getlayer(TCP).flags == 0x12:
            # 3. Formateamos el resultado con el servicio
            resultado = f"[+] Puerto {puerto: <5} | {nombre_servicio: <25} | ESTADO: ABIERTO"
            print(resultado)
            resumen_reporte += resultado + "\n"
        else:
            resultado = f"[-] Puerto {puerto: <5} | {nombre_servicio: <25} | ESTADO: Cerrado"
            print(resultado)
            resumen_reporte += resultado + "\n"
    else:
        resultado = f"[?] Puerto {puerto: <5} | {nombre_servicio: <25} | ESTADO: Filtrado"
        print(resultado)
        resumen_reporte += resultado + "\n"

print("-" * 50)
nombre_pdf = f"Reporte_{objetivo.replace('.', '_')}.pdf"
crear_pdf(nombre_pdf, resumen_reporte)
print(f"üìÑ ¬°PDF generado con √©xito!")