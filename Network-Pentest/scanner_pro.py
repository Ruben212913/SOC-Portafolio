import requests
import socket
import sys
import os
from scapy.all import *
from generar_reporte import crear_pdf
from datetime import datetime
from playwright.sync_api import sync_playwright

os.makedirs("resultados/capturas", exist_ok=True)
os.makedirs("resultados/pdfs", exist_ok=True)

# CONFIGURACI√ìN
VT_API_KEY = "15fb68355c222b4c34ff360792db6c4c361ae7d6e2d47fabe83acf46920c173f"

def obtener_geolocalizacion(ip):
    try:
        res = requests.get(f"http://ip-api.com/json/{ip}").json()
        return f"UBICACION: {res.get('city')}, {res.get('country')} | ISP: {res.get('isp')}"
    except: return "UBICACION: No disponible"

def consultar_virustotal(ip):
    headers = {"x-apikey": VT_API_KEY}
    try:
        res = requests.get(f"https://www.virustotal.com/api/v3/ip_addresses/{ip}", headers=headers)
        s = res.json()['data']['attributes']['last_analysis_stats']
        return f"REPUTACION: Maliciosos: {s['malicious']} | Sospechosos: {s['suspicious']}"
    except: return "REPUTACION: Sin datos"

def detectar_version(ip, puerto):
    try:
        s = socket.socket()
        s.settimeout(1.5)
        s.connect((ip, puerto))
        if puerto == 80: s.send(b"HEAD / HTTP/1.1\r\nHost: " + ip.encode() + b"\r\n\r\n")
        banner = s.recv(1024).decode(errors='ignore').strip()
        s.close()
        return banner[:60] if banner else "Servicio activo (sin banner)"
    except: return "No disponible"

def capturar_pantalla(ip, puerto):
    try:
        with sync_playwright() as p:
            browser = p.chromium.launch(headless=True)
            page = browser.new_page()
            url = f"http://{ip}" if puerto == 80 else f"https://{ip}"
            page.goto(url, timeout=5000)
            path = f"resultados/capturas/evidencia_{ip}_{puerto}.png"
            
            page.screenshot(path=path)
            browser.close()
            return path 
    except: return None

def analizar_riesgo_mitre(puerto):
    # Base de datos local basada en MITRE ATT&CK y riesgos comunes
    base_riesgos = {
        21: "RIESGO: Acceso no cifrado. Exposici√≥n a robo de credenciales (T1552).",
        22: "RIESGO: Fuerza bruta en SSH (T1110). Si la version es vieja, permite ejecucion remota.",
        80: "RIESGO: Trafico claro. Vulnerable a Inyeccion SQL o Cross-Site Scripting (T1190).",
        443: "RIESGO: Aunque es seguro, puede ocultar tuneles de Comando y Control (C2) (T1573).",
        445: "RIESGO CRITICO: Protocolo SMB. Posible propagacion de Ransomware (T1210 - Lateral Movement).",
        3389: "RIESGO ALTO: Escritorio Remoto (RDP). Punto principal de entrada para intrusos (T1133).",
        3306: "RIESGO: Base de datos expuesta. Riesgo de exfiltracion de datos sensibles (T1537)."
    }
    return base_riesgos.get(puerto, "RIESGO: Servicio no clasificado. Requiere investigacion manual.")

def scanner_pro():
    objetivo = input("üåê Ingrese IP a auditar: ")
    print(f"[*] Iniciando Reconocimiento Profundo sobre {objetivo}...")
    
    resumen = f"AUDITORIA PROFUNDA - {objetivo}\n"
    resumen += obtener_geolocalizacion(objetivo) + "\n"
    resumen += consultar_virustotal(objetivo) + "\n"
    resumen += "="*60 + "\n"
    
    os_identificado = False
    
    for puerto in range(1, 1025):
        sys.stdout.write(f"\r[*] Escaneando puerto: {puerto}")
        sys.stdout.flush()
        
        paquete = IP(dst=objetivo)/TCP(dport=puerto, flags="S")
        res = sr1(paquete, timeout=0.6, verbose=False)
        
        if res and res.haslayer(TCP) and res.getlayer(TCP).flags == 0x12:
            print(f"\n[+] PUERTO {puerto} ABIERTO")
            
            # 1. Identificaci√≥n de OS (Se mantiene igual)
            if not os_identificado:
                ttl = res.getlayer(IP).ttl
                os_type = "Linux" if ttl <= 64 else "Windows" if ttl <= 128 else "Network Device"
                resumen += f"SISTEMA OPERATIVO ESTIMADO: {os_type} (TTL: {ttl})\n"
                os_identificado = True
            
            # 2. Detecci√≥n de Versi√≥n (Se mantiene igual)
            ver = detectar_version(objetivo, puerto)
            
            # 3. NUEVO: An√°lisis de Riesgo MITRE
            riesgo = analizar_riesgo_mitre(puerto) # <--- Llamamos a la nueva funci√≥n
            
            # 4. Construcci√≥n del Reporte (Mejorado)
            resumen += f"\n--- HALLAZGO: PUERTO {puerto} ---\n"
            resumen += f"SERVICIO: {ver}\n"
            resumen += f"AMENAZA: {riesgo}\n" # <--- Ahora el PDF explica el peligro
            
            # 5. Captura de pantalla (Se mantiene igual)
            if puerto in [80, 443]:
                print(f"    üì∏ Tomando captura del puerto {puerto}...")
                foto = capturar_pantalla(objetivo, puerto)
                if foto: resumen += f"    EVIDENCIA VISUAL: {foto}\n"
            
            resumen += "-"*40 + "\n"

    # Generar PDF final
    resumen_seguro = resumen.encode('latin-1', 'ignore').decode('latin-1')
    nombre_archivo_pdf = f"resultados/pdfs/Pro_{objetivo.replace('.','_')}.pdf"
    crear_pdf(nombre_archivo_pdf, resumen_seguro)
    
    print(f"\n\n‚úÖ Auditor√≠a completa. Reporte generado en: {nombre_archivo_pdf}")

if __name__ == "__main__":
    scanner_pro()
